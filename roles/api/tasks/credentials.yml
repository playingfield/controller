---

- name: "Read Ansible SSH key from system"
  ansible.builtin.slurp:
    path: "/home/semaphore/.ssh/id_ed25519"
  register: "ssh_key_ansible"
  no_log: "{{ not debug }}"

- name: "Configure Key Store"
  block:

    - name: "Determine keys"
      changed_when: false
      check_mode: false
      ansible.builtin.uri:
        url: "{{ semaphore_api_url }}/project/{{ semaphore_project_id }}/keys"
        method: GET
        headers:
          Cookie: "{{ cookie }}"
        status_code: 200
      register: "semaphore_keystores"

    - name: "Create SSH key for Controller"
      changed_when: "semaphore_key_ansible_created.status == 204"
      ansible.builtin.uri:
        url: "{{ semaphore_api_url }}/project/{{ semaphore_project_id }}/keys"
        method: POST
        headers:
          Cookie: "{{ cookie }}"
        # project_id must be integer
        body: >-
          {
            "project_id": {{ semaphore_project_id | int }},
            "name": "Controller-ssh-key",
            "type": "ssh",
            "ssh":
            {
              "private_key": {{ ssh_key_ansible.content | b64decode | to_json }},
              "passphrase": "{{ ssh_passphrase }}"
            }
          }
        body_format: json
        status_code: 204
      register: semaphore_key_ansible_created
      when:
        - "semaphore_keystores.json | selectattr('name', 'equalto', 'Controller-ssh-key') | length == 0"

    - name: "Semaphore | Read ssh key from system"
      delegate_to: localhost
      connection: local
      become: false
      no_log: "{{ not debug }}"
      ansible.builtin.slurp:
        path: "{{ my_github_key }}"
      register: "ssh_key_github"

    - name: "Create SSH key for GitHub"
      changed_when: "semaphore_key_github_created.status == 204"
      ansible.builtin.uri:
        use_proxy: false
        url: "{{ semaphore_api_url }}/project/{{ semaphore_project_id }}/keys"
        method: POST
        headers:
          Cookie: "{{ cookie }}"
        body: >-
          {
            "project_id": {{ semaphore_project_id | int }},
            "name": "github-ssh-key",
            "type": "ssh",
            "ssh":
            {
              "private_key": {{ ssh_key_github.content | b64decode | to_json }},
              "passphrase": "{{ ssh_passphrase | default('') }}"
            }
          }
        body_format: json
        status_code: 204
        timeout: 5
      register: semaphore_key_github_created
      when:
        - "semaphore_keystores.json | selectattr('name', 'equalto', 'github-ssh-key') | length == 0"
